// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
try {
    const keys = ['currentUser', 'userCards', 'pendingWeb3Activation'];
    keys.forEach(key => {
        const item = localStorage.getItem(key);
        if (item && item !== 'undefined' && item !== 'null') {
            try {
                JSON.parse(item);
            } catch (e) {
                console.warn(`Removing corrupted localStorage item: ${key}`);
                localStorage.removeItem(key);
            }
        }
    });
} catch (error) {
    console.error('Error cleaning localStorage:', error);
}

// WEB3 –∫–æ—à–µ–ª–µ–∫ –¥–ª—è CardGift - opBNB + SafePal –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø)
class WalletManager {
    constructor() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        this.config = window.CONTRACT_CONFIG || null;
        
        if (!this.config) {
            console.error('‚ùå CONTRACT_CONFIG –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ config.js');
            return;
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ config
        this.contractAddress = this.config.CONTRACT_ADDRESS;
        this.contractABI = this.config.CONTRACT_ABI;
        this.chainId = this.config.CHAIN_ID;
        this.prices = this.config.PRICES;
        
        // opBNB –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        this.networkConfig = {
            chainId: '0xCC', // 204 –≤ hex
            chainName: this.config.CHAIN_NAME,
            nativeCurrency: {
                name: this.config.CURRENCY_SYMBOL,
                symbol: this.config.CURRENCY_SYMBOL,
                decimals: this.config.CURRENCY_DECIMALS
            },
            rpcUrls: [this.config.RPC_URL],
            blockExplorerUrls: [this.config.BLOCK_EXPLORER]
        };
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        this.web3 = null;
        this.contract = null;
        this.currentAccount = null;
        this.isConnected = false;
        this.walletType = null;
        
        console.log('‚úÖ WalletManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º SafePal');
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web3 (–ò–°–ü–†–ê–í–õ–ï–ù–û)
    async initWeb3() {
        try {
            let provider = null;
            
            // –ü–†–ò–û–†–ò–¢–ï–¢: SafePal –ø–µ—Ä–≤—ã–º –¥–µ–ª–æ–º
            if (window.safepal) {
                provider = window.safepal;
                this.walletType = 'SafePal';
                console.log('üü¢ –ò—Å–ø–æ–ª—å–∑—É–µ–º SafePal –∫–æ—à–µ–ª–µ–∫');
            } else if (window.ethereum) {
                provider = window.ethereum;
                this.walletType = 'MetaMask';
                console.log('üü° –ò—Å–ø–æ–ª—å–∑—É–µ–º MetaMask –∫–æ—à–µ–ª–µ–∫');
            } else {
                throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            }
            
            this.web3 = new Web3(provider);
            
            if (this.contractAddress && this.contractABI) {
                this.contract = new this.web3.eth.Contract(this.contractABI, this.contractAddress);
                console.log('‚úÖ –ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω:', this.contractAddress);
                return true;
            } else {
                throw new Error('–ê–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏–ª–∏ ABI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Web3:', error);
            return false;
        }
    }
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–£–ü–†–û–©–ï–ù–ù–´–ô)
    async connectWallet() {
    try {
        let accounts = [];
        
        if (this.walletType === 'safepal' && window.safepal) {
            // SafePal —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π API
            console.log('üîµ –ü–æ–¥–∫–ª—é—á–∞–µ–º SafePal —á–µ—Ä–µ–∑ .connect()...');
            
            // SafePal –∏—Å–ø–æ–ª—å–∑—É–µ—Ç .connect() –≤–º–µ—Å—Ç–æ .request()
            const result = await window.safepal.connect();
            console.log('SafePal connect result:', result);
            
            // –ü–æ–ª—É—á–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç —á–µ—Ä–µ–∑ .getAccount()
            const account = await window.safepal.getAccount();
            console.log('SafePal account:', account);
            
            if (account) {
                accounts = [account];
            }
            
        } else if (window.ethereum) {
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Ethereum API
            console.log('‚ö™ –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫–æ—à–µ–ª–µ–∫...');
            accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
        }
        
        if (accounts && accounts.length > 0) {
            this.currentAccount = accounts[0];
            this.isConnected = true;
            
            console.log('‚úÖ –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω:', this.currentAccount);
            return {
                address: this.currentAccount,
                walletType: this.walletType
            };
        }
        
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
        throw error;
    }
}
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ opBNB
    async ensureOpBNBNetwork() {
        try {
            const chainId = await this.web3.eth.getChainId();
            
            if (chainId !== this.chainId) {
                console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ opBNB...');
                await this.switchToOpBNB();
            } else {
                console.log('‚úÖ –£–∂–µ –≤ —Å–µ—Ç–∏ opBNB');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ç–∏:', error);
            throw error;
        }
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ opBNB
    async switchToOpBNB() {
        try {
            const provider = window.safepal || window.ethereum;
            
            await provider.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: this.networkConfig.chainId }]
            });
            
            console.log('‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞ opBNB');
            
        } catch (switchError) {
            if (switchError.code === 4902) {
                console.log('‚ûï –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç—å opBNB...');
                await this.addOpBNBNetwork();
            } else {
                throw switchError;
            }
        }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ opBNB —Å–µ—Ç–∏
    async addOpBNBNetwork() {
        const provider = window.safepal || window.ethereum;
        
        await provider.request({
            method: 'wallet_addEthereumChain',
            params: [this.networkConfig]
        });
        
        console.log('‚úÖ –°–µ—Ç—å opBNB –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
    async getBalance() {
        if (!this.currentAccount) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        const balance = await this.web3.eth.getBalance(this.currentAccount);
        return this.web3.utils.fromWei(balance, 'ether');
    }
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async registerUser(referrerId = '') {
        if (!this.isConnected) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        try {
            console.log('üìù –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            const result = await this.contract.methods
                .registerUser(referrerId)
                .send({ 
                    from: this.currentAccount,
                    gas: 300000
                });
                
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
            throw error;
        }
    }
    
    // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (0.0025 BNB)
    async activateUser() {
        if (!this.isConnected) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        try {
            console.log('üí∞ –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            const result = await this.contract.methods
                .activateUser()
                .send({ 
                    from: this.currentAccount,
                    value: this.prices.ACTIVATION,
                    gas: 200000
                });
                
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏:', error);
            throw error;
        }
    }
    
    // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–∏–Ω–∏-–∞–¥–º–∏–Ω–∞ (0.05 BNB)
    async activateMiniAdmin() {
        if (!this.isConnected) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        try {
            console.log('üëë –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –º–∏–Ω–∏-–∞–¥–º–∏–Ω–∞...');
            
            const result = await this.contract.methods
                .activateMiniAdmin()
                .send({ 
                    from: this.currentAccount,
                    value: this.prices.MINI_ADMIN,
                    gas: 250000
                });
                
            console.log('‚úÖ –ú–∏–Ω–∏-–∞–¥–º–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –º–∏–Ω–∏-–∞–¥–º–∏–Ω–∞:', error);
            throw error;
        }
    }
    
    // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û: –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ (0.25 BNB)
    async activateSuperAdmin() {
        if (!this.isConnected) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        try {
            console.log('üëë –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞...');
            
            const result = await this.contract.methods
                .activateSuperAdmin()
                .send({ 
                    from: this.currentAccount,
                    value: this.prices.SUPER_ADMIN,
                    gas: 300000
                });
                
            console.log('‚úÖ –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞:', error);
            throw error;
        }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∫–∏
    async createCard(metadataHash) {
        if (!this.isConnected) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        try {
            console.log('üé® –°–æ–∑–¥–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∫—É...');
            
            const result = await this.contract.methods
                .createCard(metadataHash)
                .send({ 
                    from: this.currentAccount,
                    gas: 200000
                });
                
            console.log('‚úÖ –û—Ç–∫—Ä—ã—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∫–∏:', error);
            throw error;
        }
    }
    
    // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û: –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–∫–∏
    async deleteCard(cardId) {
        if (!this.isConnected) {
            throw new Error('–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
        
        try {
            console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç–∫—É...');
            
            const result = await this.contract.methods
                .deleteCard(cardId)
                .send({ 
                    from: this.currentAccount,
                    gas: 150000
                });
                
            console.log('‚úÖ –û—Ç–∫—Ä—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞:', result);
            return result;
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∫–∏:', error);
            throw error;
        }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async getUser(userId) {
        try {
            const result = await this.contract.methods
                .getUser(userId)
                .call();
                
            return {
                userId: result[0],
                wallet: result[1],
                level: parseInt(result[2]),
                referrerId: result[3],
                registrationTime: result[4],
                isActive: result[5],
                cardCount: result[6],
                totalEarned: result[7]
            };
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            throw error;
        }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
    async getUserReferrals(userId) {
        try {
            return await this.contract.methods
                .getUserReferrals(userId)
                .call();
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:', error);
            throw error;
        }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async getUserCards(userId) {
        try {
            return await this.contract.methods
                .getUserCards(userId)
                .call();
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–∫:', error);
            throw error;
        }
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    isWalletConnected() {
        return this.isConnected && this.currentAccount;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
    getAddress() {
        return this.currentAccount;
    }
    
    // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
    disconnect() {
        this.currentAccount = null;
        this.isConnected = false;
        this.walletType = null;
        this.web3 = null;
        this.contract = null;
        console.log('üîå –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
    }
}

// –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
window.walletManager = new WalletManager();

// –£–ü–†–û–©–ï–ù–ù–û–ï –∞–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
document.addEventListener('DOMContentLoaded', async () => {
    try {
        const provider = window.safepal || window.ethereum;
        
        if (provider) {
            const accounts = await provider.request({
                method: 'eth_accounts'
            });
            
            if (accounts.length > 0) {
                await walletManager.connectWallet();
                console.log('‚úÖ –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ');
            }
        }
    } catch (error) {
        console.log('‚ÑπÔ∏è –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∫–æ—à–µ–ª—å–∫–∞
if (window.safepal) {
    window.safepal.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
            walletManager.disconnect();
            window.location.reload();
        } else {
            walletManager.currentAccount = accounts[0];
        }
    });
    
    window.safepal.on('chainChanged', () => {
        window.location.reload();
    });
} else if (window.ethereum) {
    window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length === 0) {
            walletManager.disconnect();
            window.location.reload();
        } else {
            walletManager.currentAccount = accounts[0];
        }
    });
    
    window.ethereum.on('chainChanged', () => {
        window.location.reload();
    });
}
